{% extends 'base.html' %}
{% load static %}

{% block title %}
{% if is_resident_view %}Mes Documents{% else %}Gestion des Documents{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* ===== STYLES DOCUMENTS MODERNES ===== */
    .document-card {
        border-radius: var(--radius-xl);
        border: var(--border-width) solid var(--border-color);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
        background: var(--card-bg);
    }
    
    .document-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }
    
    .document-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .document-type-badge {
        font-size: var(--font-size-xs);
        padding: var(--spacing-2) var(--spacing-4);
        border-radius: var(--radius-full);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .payment-status {
        font-size: var(--font-size-sm);
        padding: var(--spacing-2) var(--spacing-4);
        border-radius: var(--radius-full);
        font-weight: var(--font-weight-semibold);
    }
    
    .amount-display {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-extrabold);
    }
    
    .overdue-indicator {
        animation: pulse-danger 2s infinite;
    }
    
    @keyframes pulse-danger {
        0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
    
    .filters-section {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: var(--radius-xl);
        padding: var(--spacing-6);
        color: var(--white);
        margin-bottom: var(--spacing-8);
        box-shadow: var(--shadow-md);
    }
    
    .filters-section h6 {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--spacing-4);
    }
    
    .stats-overview {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-xl);
        padding: var(--spacing-6);
        margin-bottom: var(--spacing-8);
        border: var(--border-width) solid rgba(255,255,255,0.3);
        box-shadow: var(--shadow-sm);
    }
    
    .stats-overview i {
        font-size: var(--font-size-3xl);
        margin-bottom: var(--spacing-3);
    }
    
    .stats-overview h4 {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-extrabold);
        margin-bottom: var(--spacing-2);
    }
    
    .empty-state {
        text-align: center;
        padding: var(--spacing-16) var(--spacing-4);
    }
    
    .empty-state i {
        font-size: var(--font-size-5xl);
        margin-bottom: var(--spacing-4);
        opacity: 0.5;
        color: var(--text-muted);
    }
    
    .empty-state h4 {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-2);
    }
    
    .empty-state p {
        font-size: var(--font-size-base);
        color: var(--text-muted);
        margin-bottom: var(--spacing-6);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- ===== EN-TÊTE DE PAGE ===== -->
            {% include 'components/page_header.html' with title=title|default:"Documents" icon="fas fa-file-alt" subtitle=subtitle|default:"Gérez vos documents" actions=page_actions|default:None %}

            <!-- Filtres pour Syndic -->
            {% if not is_resident_view %}
            <div class="filters-section">
                <h6 class="mb-3"><i class="fas fa-filter me-2"></i>Filtres et Options</h6>
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Type de Document</label>
                        <select name="document_type" class="form-select">
                            <option value="">Tous les types</option>
                            <option value="INVOICE">Facture</option>
                            <option value="NOTICE">Avis</option>
                            <option value="REMINDER">Rappel</option>
                            <option value="LEGAL">Document légal</option>
                            <option value="OTHER">Autre</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Statut de Paiement</label>
                        <select name="payment_status" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option value="paid">Payé</option>
                            <option value="unpaid">Non payé</option>
                            <option value="overdue">En retard</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Date début</label>
                        <input type="date" name="date_start" class="form-control" value="{{ request.GET.date_start }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Date fin</label>
                        <input type="date" name="date_end" class="form-control" value="{{ request.GET.date_end }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-light me-2 w-100">
                            <i class="fas fa-search"></i> Filtrer
                        </button>
                    </div>
                </form>
                
                <div class="mt-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="archived" value="1" 
                               {% if request.GET.archived %}checked{% endif %} onchange="this.form.submit()">
                        <label class="form-check-label">Inclure les documents archivés</label>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Statistiques Générales -->
            {% if not is_resident_view and stats %}
            <div class="stats-overview">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                            <h4 class="mb-1">{{ stats.total }}</h4>
                            <span class="text-muted">Total Documents</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <h4 class="mb-1">{{ stats.paid }}</h4>
                            <span class="text-muted">Payés</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h4 class="mb-1">{{ stats.unpaid }}</h4>
                            <span class="text-muted">En Attente</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                            <h4 class="mb-1">{{ stats.overdue }}</h4>
                            <span class="text-muted">En Retard</span>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="row text-center">
                    <div class="col-md-6">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-coins fa-2x text-info mb-2"></i>
                            <h4 class="mb-1">{{ stats.total_amount|floatformat:2 }} DH</h4>
                            <span class="text-muted">Montant Total</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-money-check-alt fa-2x text-success mb-2"></i>
                            <h4 class="mb-1">{{ stats.paid_amount|floatformat:2 }} DH</h4>
                            <span class="text-muted">Montant Payé</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Liste des Documents -->
            {% if documents %}
            <div class="row">
                {% for document in documents %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="document-card modern-card h-100">
                        <div class="card-body p-4">
                            <!-- Header du document -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <h6 class="card-title text-primary mb-1">{{ document.title }}</h6>
                                    <small class="text-muted">{{ document.date|date:"d/m/Y" }}</small>
                                </div>
                                <span class="document-type-badge
                                    {% if document.document_type == 'INVOICE' %}bg-danger text-white
                                    {% elif document.document_type == 'NOTICE' %}bg-info text-white
                                    {% elif document.document_type == 'REMINDER' %}bg-warning text-dark
                                    {% elif document.document_type == 'LEGAL' %}bg-dark text-white
                                    {% else %}bg-secondary text-white{% endif %}">
                                    {{ document.get_document_type_display }}
                                </span>
                            </div>

                            <!-- Montant -->
                            <div class="mb-3">
                                <div class="amount-display 
                                    {% if document.is_paid %}text-success
                                    {% elif document.is_overdue %}text-danger
                                    {% else %}text-warning{% endif %}">
                                    {{ document.amount|floatformat:2 }} DH
                                </div>
                            </div>

                            <!-- Description -->
                            {% if document.description %}
                            <p class="card-text text-muted small mb-3">
                                {{ document.description|truncatewords:20 }}
                            </p>
                            {% endif %}

                            <!-- Statut de paiement -->
                            <div class="mb-3">
                                {% if document.is_paid %}
                                <span class="payment-status bg-success text-white">
                                    <i class="fas fa-check-circle me-1"></i>Payé
                                </span>
                                {% elif document.is_overdue %}
                                <span class="payment-status bg-danger text-white overdue-indicator">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    En retard ({{ document.days_overdue }} jours)
                                </span>
                                {% else %}
                                <span class="payment-status bg-warning text-dark">
                                    <i class="fas fa-clock me-1"></i>En attente
                                </span>
                                {% endif %}
                            </div>

                            <!-- Actions -->
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="{% url 'finance:document_detail' document.pk %}" 
                                   class="btn btn-modern btn-primary btn-sm flex-fill">
                                    <i class="fas fa-eye me-1"></i>Voir
                                </a>
                                
                                {% if document.file %}
                                <a href="{{ document.file.url }}" target="_blank" 
                                   class="btn btn-modern btn-outline btn-sm flex-fill">
                                    <i class="fas fa-download me-1"></i>Fichier
                                </a>
                                {% endif %}
                                
                                {% if not document.is_paid and document.resident == user %}
                                <a href="{% url 'finance:payment_create' document.pk %}" 
                                   class="btn btn-modern btn-success btn-sm flex-fill">
                                    <i class="fas fa-credit-card me-1"></i>Payer
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Footer avec infos -->
                        <div class="card-footer bg-light border-0 p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    {% if is_resident_view %}
                                    Ajouté le {{ document.created_at|date:"d/m/Y" }}
                                    {% else %}
                                    {{ document.resident.get_full_name|default:document.resident.username }}
                                    {% endif %}
                                </small>
                                {% if not is_resident_view %}
                                <small class="text-muted">
                                    Apt. {{ document.resident.apartment|default:"N/A" }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <nav aria-label="Pagination des documents" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link rounded-pill me-2" href="?page=1">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link rounded-pill me-2" href="?page={{ page_obj.previous_page_number }}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link rounded-pill mx-2">
                            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link rounded-pill ms-2" href="?page={{ page_obj.next_page_number }}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link rounded-pill ms-2" href="?page={{ page_obj.paginator.num_pages }}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <!-- État vide -->
            <div class="empty-state">
                <i class="fas fa-file-alt"></i>
                <h4 class="mt-3 mb-2">
                    {% if is_resident_view %}
                    Aucun document disponible
                    {% else %}
                    Aucun document créé
                    {% endif %}
                </h4>
                <p class="text-muted mb-4">
                    {% if is_resident_view %}
                    Vos documents apparaîtront ici quand le syndic les ajoutera.
                    {% else %}
                    Commencez par ajouter un document pour un résident.
                    {% endif %}
                </p>
                {% if not is_resident_view %}
                <a href="{% url 'finance:document_create' %}" class="btn btn-modern btn-primary">
                    <i class="fas fa-plus me-2"></i>Créer le Premier Document
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animation d'entrée pour les cartes
        const cards = document.querySelectorAll('.document-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        // Gestion des filtres
        const filterForm = document.querySelector('form[method="get"]');
        if (filterForm) {
            const selects = filterForm.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    if (this.value) {
                        filterForm.submit();
                    }
                });
            });
        }
    });
</script>
{% endblock %}
